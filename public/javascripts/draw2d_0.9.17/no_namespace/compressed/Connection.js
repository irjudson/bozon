/**
This notice must be untouched at all times.
This is the COMPRESSED version of Draw2D
WebSite: http://www.draw2d.org
Copyright: 2006 Andreas Herz. All rights reserved.
Created: 5.11.2006 by Andreas Herz (Web: http://www.freegroup.de )
LICENSE: LGPL
**/

Connection=function(){Line.call(this);this.sourcePort=null;this.targetPort=null;this.sourceDecorator=null;this.targetDecorator=null;this.sourceAnchor=new ConnectionAnchor();this.targetAnchor=new ConnectionAnchor();this.router=Connection.defaultRouter;this.lineSegments=new ArrayList();this.children=new ArrayList();this.setColor(new Color(0,0,115));this.setLineWidth(1);};Connection.prototype=new Line;Connection.prototype.type="Connection";Connection.defaultRouter=new ManhattanConnectionRouter();Connection.setDefaultRouter=function(_198){Connection.defaultRouter=_198;};Connection.prototype.disconnect=function(){if(this.sourcePort!=null){this.sourcePort.detachMoveListener(this);this.fireSourcePortRouteEvent();}if(this.targetPort!=null){this.targetPort.detachMoveListener(this);this.fireTargetPortRouteEvent();}};Connection.prototype.reconnect=function(){if(this.sourcePort!=null){this.sourcePort.attachMoveListener(this);this.fireSourcePortRouteEvent();}if(this.targetPort!=null){this.targetPort.attachMoveListener(this);this.fireTargetPortRouteEvent();}};Connection.prototype.isResizeable=function(){return true;};Connection.prototype.addFigure=function(_199,_19a){var _19b=new Object();_19b.figure=_199;_19b.locator=_19a;this.children.add(_19b);if(this.graphics!=null){this.paint();}var _19c=this;var _19d=function(){var _19e=arguments[0]||window.event;_19e.returnValue=false;_19c.getWorkflow().setCurrentSelection(_19c);_19c.getWorkflow().showLineResizeHandles(_19c);};if(_199.getHTMLElement().addEventListener){_199.getHTMLElement().addEventListener("mousedown",_19d,false);}else{if(this.html.attachEvent){_199.getHTMLElement().attachEvent("onmouseup",mouseUp);}}};Connection.prototype.setSourceDecorator=function(_19f){this.sourceDecorator=_19f;if(this.graphics!=null){this.paint();}};Connection.prototype.setTargetDecorator=function(_1a0){this.targetDecorator=_1a0;if(this.graphics!=null){this.paint();}};Connection.prototype.setSourceAnchor=function(_1a1){this.sourceAnchor=_1a1;this.sourceAnchor.setOwner(this.sourcePort);if(this.graphics!=null){this.paint();}};Connection.prototype.setTargetAnchor=function(_1a2){this.targetAnchor=_1a2;this.targetAnchor.setOwner(this.targetPort);if(this.graphics!=null){this.paint();}};Connection.prototype.setRouter=function(_1a3){if(_1a3!=null){this.router=_1a3;}else{this.router=new NullConnectionRouter();}if(this.graphics!=null){this.paint();}};Connection.prototype.getRouter=function(){return this.router;};Connection.prototype.setWorkflow=function(_1a4){Line.prototype.setWorkflow.call(this,_1a4);for(var i=0;i<this.children.getSize();i++){this.children.get(i).isAppended=false;}};Connection.prototype.paint=function(){for(var i=0;i<this.children.getSize();i++){var _1a7=this.children.get(i);if(_1a7.isAppended==true){this.html.removeChild(_1a7.figure.getHTMLElement());}_1a7.isAppended=false;}if(this.graphics==null){this.graphics=new jsGraphics(this.id);}else{this.graphics.clear();}this.graphics.setStroke(this.stroke);this.graphics.setColor(this.lineColor.getHTMLStyle());this.startStroke();this.router.route(this);if(this.getSource().getParent().isMoving==false&&this.getTarget().getParent().isMoving==false){if(this.targetDecorator!=null){this.targetDecorator.paint(new Graphics(this.graphics,this.getEndAngle(),this.getEndPoint()));}if(this.sourceDecorator!=null){this.sourceDecorator.paint(new Graphics(this.graphics,this.getStartAngle(),this.getStartPoint()));}}this.finishStroke();for(var i=0;i<this.children.getSize();i++){var _1a7=this.children.get(i);this.html.appendChild(_1a7.figure.getHTMLElement());_1a7.isAppended=true;_1a7.locator.relocate(_1a7.figure);}};Connection.prototype.getStartPoint=function(){if(this.isMoving==false){return this.sourceAnchor.getLocation(this.targetAnchor.getReferencePoint());}else{return Line.prototype.getStartPoint.call(this);}};Connection.prototype.getEndPoint=function(){if(this.isMoving==false){return this.targetAnchor.getLocation(this.sourceAnchor.getReferencePoint());}else{return Line.prototype.getEndPoint.call(this);}};Connection.prototype.startStroke=function(){this.oldPoint=null;this.lineSegments=new ArrayList();};Connection.prototype.finishStroke=function(){this.graphics.paint();this.oldPoint=null;};Connection.prototype.getPoints=function(){var _1a8=new ArrayList();var line;for(var i=0;i<this.lineSegments.getSize();i++){line=this.lineSegments.get(i);_1a8.add(line.start);}_1a8.add(line.end);return _1a8;};Connection.prototype.addPoint=function(p){p=new Point(parseInt(p.x),parseInt(p.y));if(this.oldPoint!=null){this.graphics.drawLine(this.oldPoint.x,this.oldPoint.y,p.x,p.y);var line=new Object();line.start=this.oldPoint;line.end=p;this.lineSegments.add(line);}this.oldPoint=new Object();this.oldPoint.x=p.x;this.oldPoint.y=p.y;};Connection.prototype.setSource=function(port){if(this.sourcePort!=null){this.sourcePort.detachMoveListener(this);}this.sourcePort=port;if(this.sourcePort==null){return;}this.sourceAnchor.setOwner(this.sourcePort);this.fireSourcePortRouteEvent();this.sourcePort.attachMoveListener(this);this.setStartPoint(port.getAbsoluteX(),port.getAbsoluteY());};Connection.prototype.getSource=function(){return this.sourcePort;};Connection.prototype.setTarget=function(port){if(this.targetPort!=null){this.targetPort.detachMoveListener(this);}this.targetPort=port;if(this.targetPort==null){return;}this.targetAnchor.setOwner(this.targetPort);this.fireTargetPortRouteEvent();this.targetPort.attachMoveListener(this);this.setEndPoint(port.getAbsoluteX(),port.getAbsoluteY());};Connection.prototype.getTarget=function(){return this.targetPort;};Connection.prototype.onOtherFigureMoved=function(_1af){if(_1af==this.sourcePort){this.setStartPoint(this.sourcePort.getAbsoluteX(),this.sourcePort.getAbsoluteY());}else{this.setEndPoint(this.targetPort.getAbsoluteX(),this.targetPort.getAbsoluteY());}};Connection.prototype.containsPoint=function(px,py){for(var i=0;i<this.lineSegments.getSize();i++){var line=this.lineSegments.get(i);if(Line.hit(this.corona,line.start.x,line.start.y,line.end.x,line.end.y,px,py)){return true;}}return false;};Connection.prototype.getStartAngle=function(){var p1=this.lineSegments.get(0).start;var p2=this.lineSegments.get(0).end;if(this.router instanceof BezierConnectionRouter){p2=this.lineSegments.get(5).end;}var _1b6=Math.sqrt((p1.x-p2.x)*(p1.x-p2.x)+(p1.y-p2.y)*(p1.y-p2.y));var _1b7=-(180/Math.PI)*Math.asin((p1.y-p2.y)/_1b6);if(_1b7<0){if(p2.x<p1.x){_1b7=Math.abs(_1b7)+180;}else{_1b7=360-Math.abs(_1b7);}}else{if(p2.x<p1.x){_1b7=180-_1b7;}}return _1b7;};Connection.prototype.getEndAngle=function(){var p1=this.lineSegments.get(this.lineSegments.getSize()-1).end;var p2=this.lineSegments.get(this.lineSegments.getSize()-1).start;if(this.router instanceof BezierConnectionRouter){p2=this.lineSegments.get(this.lineSegments.getSize()-5).end;}var _1ba=Math.sqrt((p1.x-p2.x)*(p1.x-p2.x)+(p1.y-p2.y)*(p1.y-p2.y));var _1bb=-(180/Math.PI)*Math.asin((p1.y-p2.y)/_1ba);if(_1bb<0){if(p2.x<p1.x){_1bb=Math.abs(_1bb)+180;}else{_1bb=360-Math.abs(_1bb);}}else{if(p2.x<p1.x){_1bb=180-_1bb;}}return _1bb;};Connection.prototype.fireSourcePortRouteEvent=function(){var _1bc=this.sourcePort.getConnections();for(var i=0;i<_1bc.getSize();i++){_1bc.get(i).paint();}};Connection.prototype.fireTargetPortRouteEvent=function(){var _1be=this.targetPort.getConnections();for(var i=0;i<_1be.getSize();i++){_1be.get(i).paint();}};Connection.prototype.createCommand=function(_1c0){if(_1c0.getPolicy()==EditPolicy.MOVE){return new CommandReconnect(this);}if(_1c0.getPolicy()==EditPolicy.DELETE){if(this.isDeleteable()==true){return new CommandDelete(this);}return null;}return null;};